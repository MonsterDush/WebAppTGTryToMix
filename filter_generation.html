<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Фильтр‑генерации — TryToMix</title>
  <style>
    /* Палитры (из вашего гайда) */
    :root{
      /* 1. Гламур и уют */
      --lemongrass:#9BA17B; /* зелёный */
      --primrose:#F6D1D1;  /* нежный розовый */
      --hotchoc:#4E342E;   /* коричневый */
      --damson:#672146;    /* пурпурный */
      /* 2. Яркость и сила */
      --lyons:#006D77;     /* тёмно‑бирюзовый */
      --poppy:#E63946;     /* красный */
      --chilioil:#B23A30;  /* пряный красный */
      --melon:#F6A57F;     /* тёплый оранжевый */
      /* 3. Тёплая натуральность */
      --bronze:#7C5A3E;    /* бронзово‑коричневый */
      --winterberry:#A23B5A;/* ягодный красный */
      --desertsun:#E0AD2F; /* песочно‑жёлтый */
      --lavblue:#C3CDE6;   /* лавандовый */

      /* Базовые */
      --bg: #FFF7F2;             /* мягкий почти персиковый фон */
      --card:#FFFFFF;
      --text:#1E1E1E;
      --muted:#6B6B6B;
      --accent: var(--lyons);    /* кнопки/акценты */
      --accent-2: var(--melon);
      --ok: #2E7D32;
      --err:#C62828;
      --br:16px; --pad:16px; --shadow:0 8px 24px rgba(0,0,0,.08);
    }
    html,body{margin:0; padding:0; background:var(--bg); color:var(--text); font:16px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;}
    .wrap{max-width:720px; margin:0 auto; padding:24px;}
    header{display:flex; align-items:center; gap:12px; margin-bottom:20px;}
    header img{width:36px; height:36px; object-fit:contain; border-radius:8px;}
    h1{font-size:20px; margin:0;}
    .card{background:var(--card); border-radius:var(--br); padding:var(--pad); box-shadow:var(--shadow); margin-bottom:16px;}
    .sub{font-weight:600; margin:0 0 8px 0;}
    .hint{font-size:13px; color:var(--muted); margin:4px 0 0 0;}
    .grid{display:grid; grid-template-columns:1fr; gap:12px;}
    .row{display:flex; flex-wrap:wrap; gap:8px;}
    .chip{border:1px solid #E8E8E8; padding:10px 12px; border-radius:12px; cursor:pointer; background:#fff;}
    .chip.active{background:var(--lavblue); border-color:var(--lavblue);} /* мягкий актив */
    .chip.single.active{background:var(--primrose);} /* радио‑выбор */
    .actions{position:sticky; bottom:0; background:linear-gradient(180deg, rgba(255,247,242,0) 0%, var(--bg) 40%); padding:16px 0 8px;}
    button{width:100%; padding:14px 16px; border:none; border-radius:14px; font-weight:700; cursor:pointer;}
    .save{background:var(--accent); color:#fff;}
    .save:disabled{opacity:.6; cursor:not-allowed;}
    .err{color:var(--err); margin:8px 0 0;}
    .ok{color:var(--ok); margin:8px 0 0;}
  </style>
  <script>
    // Вспомогалки: читаем ?p= для префилла
    function getPrefill(){
      const qs = new URLSearchParams(location.search);
      const p = qs.get('p');
      if(!p) return null;
      try{
        // восстановим padding
        const pad = p.length % 4; const s = pad ? p + '='.repeat(4-pad) : p;
        const json = atob(s.replace(/-/g,'+').replace(/_/g,'/'));
        return JSON.parse(json);
      }catch(e){ return null; }
    }

    // Локальные справочники — должны совпадать с беком
    const CATEGORY_OPTIONS = [
      {id:1, title:'Цитрус'}, {id:2, title:'Ягоды'}, {id:3, title:'Тропики'}, {id:4, title:'Мята/Свежесть'},
      {id:5, title:'Десерт'}, {id:6, title:'Пряности'}, {id:7, title:'Кислые'}, {id:8, title:'Флора'}
    ];
    const STRONG_OPTIONS = ['soft','medium','strong'];
    const TASTE_OPTIONS  = ['sweet','neutral','acid'];

    let selectedCats = new Set(); // 1–2 шт
    let selectedStrong = null;    // строго 1
    let selectedTaste  = null;    // строго 1
    let excludedCats   = new Set(); // 0..∞

    function renderChips(list, container, {single=false, selectedSet, selectedValue, onToggle}){
      container.innerHTML='';
      list.forEach(opt => {
        const chip = document.createElement('div');
        chip.className = 'chip' + (single ? ' single' : '');
        chip.textContent = opt.title || opt;
        const isActive = single ? (selectedValue===opt) : selectedSet.has(opt.id);
        if(isActive) chip.classList.add('active');
        chip.onclick = ()=> onToggle(opt, chip);
        container.appendChild(chip);
      });
    }

    function validate(){
      // mode A: 1–2 cats + 1 strong + 1 taste
      const a = (selectedCats.size>=1 && selectedCats.size<=2) && !!selectedStrong && !!selectedTaste;
      // mode B: only exclusions
      const b = (selectedCats.size===0 && !selectedStrong && !selectedTaste && excludedCats.size>0);
      return a || b;
    }

    function updateSave(){
      const btn = document.getElementById('btnSave');
      btn.disabled = !validate();
      document.getElementById('err').textContent = btn.disabled ? 'Нужно заполнить 1–3 (или выбрать только исключения в пункте 4).' : '';
    }

    function prefillFromData(rec){
      if(!rec) return;
      const mf = rec.mix_filter; const excl = rec.exclude_categories||[];
      if(Array.isArray(excl)) excl.forEach(x=>excludedCats.add(Number(x)));
      if(Array.isArray(mf) && mf.length===3){
        const [s,t,cats]=mf;
        selectedStrong = STRONG_OPTIONS.includes(s)? s : null;
        selectedTaste  = TASTE_OPTIONS.includes(t)? t : null;
        if(Array.isArray(cats)) cats.forEach(x=>selectedCats.add(Number(x)));
      }
    }

    function init(){
      const tg = window.Telegram?.WebApp; if(tg){ tg.expand(); }
      prefillFromData(getPrefill());

      // Категории (1–2)
      renderChips(CATEGORY_OPTIONS, document.getElementById('cats'), {
        selectedSet:selectedCats,
        onToggle:(opt, chip)=>{
          if(selectedCats.has(opt.id)){ selectedCats.delete(opt.id); chip.classList.remove('active'); }
          else{
            if(selectedCats.size>=2){ return; } // максимум 2
            selectedCats.add(opt.id); chip.classList.add('active');
          }
          updateSave();
        }
      });

      // Крепость (radio)
      renderChips(STRONG_OPTIONS, document.getElementById('strong'), {
        single:true, selectedValue:selectedStrong,
        onToggle:(opt, chip)=>{
          const cont = document.getElementById('strong');
          [...cont.children].forEach(el=>el.classList.remove('active'));
          if(selectedStrong===opt){ selectedStrong=null; chip.classList.remove('active'); }
          else{ selectedStrong=opt; chip.classList.add('active'); }
          updateSave();
        }
      });

      // Вкус (radio)
      renderChips(TASTE_OPTIONS, document.getElementById('taste'), {
        single:true, selectedValue:selectedTaste,
        onToggle:(opt, chip)=>{
          const cont = document.getElementById('taste');
          [...cont.children].forEach(el=>el.classList.remove('active'));
          if(selectedTaste===opt){ selectedTaste=null; chip.classList.remove('active'); }
          else{ selectedTaste=opt; chip.classList.add('active'); }
          updateSave();
        }
      });

      // Исключения
      renderChips(CATEGORY_OPTIONS, document.getElementById('exclude'), {
        selectedSet:excludedCats,
        onToggle:(opt, chip)=>{
          if(excludedCats.has(opt.id)){ excludedCats.delete(opt.id); chip.classList.remove('active'); }
          else{ excludedCats.add(opt.id); chip.classList.add('active'); }
          updateSave();
        }
      });

      updateSave();

      document.getElementById('btnSave').onclick = ()=>{
        const modeA = (selectedCats.size>=1 && selectedCats.size<=2) && !!selectedStrong && !!selectedTaste;
        const payload = {
          categories: modeA ? Array.from(selectedCats) : [],
          strong: modeA ? selectedStrong : null,
          taste: modeA ? selectedTaste  : null,
          exclude_categories: Array.from(excludedCats)
        };
        const tg = window.Telegram?.WebApp;
        if(tg){ tg.sendData(JSON.stringify(payload)); tg.close(); }
      };
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="/Logo_TryToMix.png" alt="TryToMix"/>
      <h1>Фильтр‑генерации</h1>
    </header>

    <div class="card">
      <p class="sub">1) Категории (выбери 1–2)</p>
      <div id="cats" class="row"></div>
      <p class="hint">Можно выбрать одну или две категории для будущих миксов.</p>
    </div>

    <div class="grid">
      <div class="card">
        <p class="sub">2) Крепость (выбери 1)</p>
        <div id="strong" class="row"></div>
      </div>
      <div class="card">
        <p class="sub">3) Направление вкуса (выбери 1)</p>
        <div id="taste" class="row"></div>
      </div>
    </div>

    <div class="card">
      <p class="sub">4) Категории‑исключения (опционально)</p>
      <div id="exclude" class="row"></div>
      <p class="hint">Можно выбрать любое количество категорий, которые НЕ должны участвовать в генерации.</p>
    </div>

    <div class="actions">
      <button id="btnSave" class="save" disabled>Сохранить</button>
      <div id="err" class="err"></div>
    </div>
  </div>
</body>
</html>

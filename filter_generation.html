<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Фильтр-генерации — TryToMix</title>
  <!-- ОФИЦИАЛЬНАЯ БИБЛИОТЕКА TG WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      /* Мягкая палитра */
      --bg:#FFF7F2; --card:#FFFFFF; --text:#1E1E1E; --muted:#6B6B6B;
      --accent:#006D77; --ok:#2E7D32; --err:#C62828;
      --br:16px; --pad:16px; --shadow:0 8px 24px rgba(0,0,0,.08);
    }
    html,body{margin:0; padding:0; background:var(--bg); color:var(--text); font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;}
    .wrap{max-width:720px; margin:0 auto; padding:24px;}
    header{display:flex; align-items:center; gap:12px; margin-bottom:20px;}
    header img{width:36px; height:36px; object-fit:contain; border-radius:8px;}
    h1{font-size:20px; margin:0;}
    .card{background:var(--card); border-radius:var(--br); padding:var(--pad); box-shadow:var(--shadow); margin-bottom:16px;}
    .sub{font-weight:600; margin:0 0 8px 0;}
    .hint{font-size:13px; color:var(--muted); margin:4px 0 0;}
    .row{display:flex; flex-wrap:wrap; gap:8px;}
    .chip{border:1px solid #E8E8E8; padding:10px 12px; border-radius:12px; cursor:pointer; background:#fff; user-select:none;}
    .chip.active{background:#C3CDE6; border-color:#C3CDE6;}
    .chip.single.active{background:#F6D1D1;}
    .actions{position:sticky; bottom:0; background:linear-gradient(180deg, rgba(255,247,242,0) 0%, var(--bg) 40%); padding:16px 0 8px;}
    button{width:100%; padding:14px 16px; border:none; border-radius:14px; font-weight:700; cursor:pointer;}
    .save{background:var(--accent); color:#fff;}
    .save:disabled{opacity:.6; cursor:not-allowed;}
    .err{color:var(--err); margin:8px 0 0; white-space:pre-wrap;}
    .note{font-size:13px; color:var(--muted); margin-top:8px;}
    #env{font-size:12px; color:var(--muted); margin-top:8px;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="Logo_TryToMix.png" alt="TryToMix">
      <h1>Фильтр-генерации</h1>
    </header>

    <div class="card">
      <p class="sub">1) Категории (выбери 1–2)</p>
      <div id="cats" class="row"></div>
      <p class="hint">Можно выбрать одну или две категории для будущих миксов.</p>
    </div>

    <div class="card">
      <p class="sub">2) Крепость (выбери 1)</p>
      <div id="strong" class="row"></div>
    </div>

    <div class="card">
      <p class="sub">3) Направление вкуса (выбери 1)</p>
      <div id="taste" class="row"></div>
    </div>

    <div class="card">
      <p class="sub">4) Категории-исключения (опционально)</p>
      <div id="exclude" class="row"></div>
      <p class="note">Если выбираешь только исключения — пункты 1–3 оставь пустыми.</p>
    </div>

    <div class="actions">
      <button id="btnSave" class="save" disabled>Сохранить</button>
      <div id="err" class="err"></div>
      <div id="env"></div>
    </div>
  </div>

  <script>
    // ----- каталоги (заменяются из pref.ref) -----
    let CATEGORY_OPTIONS = ["Цитрус","Ягоды"];
    let STRONG_OPTIONS   = ["Лёгкий","Средний","Крепкий"];
    let TASTE_OPTIONS    = ["Сбалансированный"];

    // числовые карты (можно также передать через pref.ref.maps)
    const STRONG_MAP = {"Без никотина":0.0,"Лёгкий":2.5,"Ниже среднего":3.5,"Средний":5.0,"Выше среднего":6.0,"Крепкий":7.5};
    const TASTE_MAP  = {"Нейтральный":0.0,"Кислый":1.0,"Кисло-сладкий":1.5,"Сбалансированный":2.0,"Сладко-кислый":2.5,"Сладкий":3.0};

    // ----- безопасное чтение префилла (UTF-8!) -----
    function getPrefill(){
      const qs = new URLSearchParams(location.search);
      const p = qs.get('p');
      if(!p) return null;
      try{
        const b64 = (p.length % 4 ? p + '='.repeat(4 - (p.length % 4)) : p).replace(/-/g,'+').replace(/_/g,'/');
        const bin = atob(b64);
        const bytes = Uint8Array.from(bin, ch => ch.charCodeAt(0));
        const json  = new TextDecoder('utf-8').decode(bytes);
        return JSON.parse(json);
      }catch(e){
        console.error('prefill decode error', e);
        showErr('Не удалось прочитать данные. Откройте форму заново из Telegram.');
        return null;
      }
    }

    function applyRefCatalogs(pref){
      const ref = pref?.ref || {};
      if (Array.isArray(ref.categories) && ref.categories.length) CATEGORY_OPTIONS = [...ref.categories];
      if (Array.isArray(ref.strongs)   && ref.strongs.length)     STRONG_OPTIONS   = [...ref.strongs];
      if (Array.isArray(ref.tastes)    && ref.tastes.length)      TASTE_OPTIONS    = [...ref.tastes];
      if (ref.maps?.strong_map) Object.assign(STRONG_MAP, ref.maps.strong_map);
      if (ref.maps?.taste_map)  Object.assign(TASTE_MAP,  ref.maps.taste_map);
    }

    function showErr(msg){ const e=document.getElementById('err'); e.textContent = msg||''; }
    function tgInstance() {
      if (window.Telegram && window.Telegram.WebApp) return window.Telegram.WebApp;
      if (window.parent && window.parent.Telegram && window.parent.Telegram.WebApp) return window.parent.Telegram.WebApp;
      return null;
    }
    function isInsideTelegram(tg){
      if (!tg) return false;
      if (typeof tg.initData === 'string' && tg.initData.length) return true;
      if (tg.platform && tg.platform.length) return true;
      return typeof tg.sendData === 'function';
    }
    function showEnv(tg){
      const el = document.getElementById('env');
      if (!el) return;
      const data = {
        hasTelegram: !!window.Telegram,
        hasWebApp: !!(window.Telegram && window.Telegram.WebApp),
        platform: tg?.platform || null,
        initDataLen: (typeof tg?.initData === 'string') ? tg.initData.length : null,
        inIframe: window.top !== window.self
      };
      el.textContent = 'ENV: ' + JSON.stringify(data);
    }

    // ----- компоненты -----
    function renderChips(list, container, {single=false, selectedSet, selectedValue, onToggle}){
      container.innerHTML='';
      list.forEach(opt => {
        const val = typeof opt === 'string' ? opt : (opt.value ?? opt.title ?? String(opt));
        const lbl = typeof opt === 'string' ? opt : (opt.title ?? String(opt));
        const chip = document.createElement('div');
        chip.className = 'chip' + (single ? ' single' : '');
        chip.textContent = lbl;
        const isActive = single ? (selectedValue===val) : selectedSet?.has?.(val);
        if(isActive) chip.classList.add('active');
        chip.onclick = ()=> onToggle(val, chip);
        container.appendChild(chip);
      });
    }
    function renderCategoryChips(container, selectedSet, onToggle){
      container.innerHTML = '';
      CATEGORY_OPTIONS.forEach((label, idx) => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.textContent = label;
        const isActive = selectedSet.has(idx);
        if(isActive) chip.classList.add('active');
        chip.onclick = ()=> onToggle(idx, chip);
        container.appendChild(chip);
      });
    }

    // ----- состояние -----
    let selectedCats = new Set();   // индексы
    let excludedCats = new Set();   // индексы
    let selectedStrong = null;      // строка
    let selectedTaste  = null;      // строка

    function validate(){
      const a = (selectedCats.size>=1 && selectedCats.size<=2) && !!selectedStrong && !!selectedTaste;
      const b = (selectedCats.size===0 && !selectedStrong && !selectedTaste && excludedCats.size>0);
      return a || b;
    }
    function updateSave(){
      const btn = document.getElementById('btnSave');
      const ok = validate();
      btn.disabled = !ok;
      showErr(ok ? '' : 'Нужно заполнить 1–3 (или выбрать только исключения в пункте 4).');
    }
    function prefillFromData(rec){
      if(!rec) return;
      const excl = rec.exclude_categories || [];
      (excl||[]).forEach(i=>excludedCats.add(Number(i)));
    
      const mf = rec.mix_filter;
      if (Array.isArray(mf) && mf.length >= 3){
        // поддержка двух форматов:
        // 1) [s_val, t_val, [idx...]]
        // 2) [s_val, t_val, idx1, idx2?]
        const s_val = mf[0], t_val = mf[1];
        let idxs;
        if (Array.isArray(mf[2])) idxs = mf[2];      // старый
        else idxs = mf.slice(2);                     // новый плоский
    
        // восстановим подписи по картам
        selectedStrong = (typeof s_val === 'number')
          ? (Object.keys(STRONG_MAP).find(k=>STRONG_MAP[k]===s_val) || null)
          : (s_val || null);
        selectedTaste  = (typeof t_val === 'number')
          ? (Object.keys(TASTE_MAP).find(k=>TASTE_MAP[k]===t_val)  || null)
          : (t_val || null);
    
        (idxs||[]).forEach(i=>selectedCats.add(Number(i)));
      }
    }

    // ----- init -----
    function init(){
      const tg = tgInstance();
      if (tg) { try{ tg.ready(); }catch(_){} try{ tg.expand(); }catch(_){} }
      showEnv(tg);

      const pref = getPrefill();
      applyRefCatalogs(pref || {});
      prefillFromData(pref || {});

      renderCategoryChips(document.getElementById('cats'), selectedCats, (idx, chip)=>{
        if(selectedCats.has(idx)){ selectedCats.delete(idx); chip.classList.remove('active'); }
        else { if(selectedCats.size>=2) return; selectedCats.add(idx); chip.classList.add('active'); }
        updateSave();
      });

      renderChips(STRONG_OPTIONS, document.getElementById('strong'), {
        single:true, selectedValue:selectedStrong,
        onToggle:(val, chip)=>{
          const cont = document.getElementById('strong');
          [...cont.children].forEach(el=>el.classList.remove('active'));
          if(selectedStrong===val){ selectedStrong=null; chip.classList.remove('active'); }
          else{ selectedStrong=val; chip.classList.add('active'); }
          updateSave();
        }
      });

      renderChips(TASTE_OPTIONS, document.getElementById('taste'), {
        single:true, selectedValue:selectedTaste,
        onToggle:(val, chip)=>{
          const cont = document.getElementById('taste');
          [...cont.children].forEach(el=>el.classList.remove('active'));
          if(selectedTaste===val){ selectedTaste=null; chip.classList.remove('active'); }
          else{ selectedTaste=val; chip.classList.add('active'); }
          updateSave();
        }
      });

      renderCategoryChips(document.getElementById('exclude'), excludedCats, (idx, chip)=>{
        if(excludedCats.has(idx)){ excludedCats.delete(idx); chip.classList.remove('active'); }
        else { excludedCats.add(idx); chip.classList.add('active'); }
        updateSave();
      });

      updateSave();

      document.getElementById('btnSave').addEventListener('click', ()=>{
        if (!validate()){
          showErr('Заполни 1–3 или выбери только исключения (4).');
          return;
        }
        const _tg = tgInstance();
        if (!_tg){
          showErr('Похоже, страница открыта не как Telegram WebApp. Открой через кнопку в боте.');
          return;
        }

        const modeA = (selectedCats.size>=1 && selectedCats.size<=2) && !!selectedStrong && !!selectedTaste;
        const payload = {
          type: 'mix_filter',
          categories_idx: modeA ? Array.from(selectedCats) : [],
          strong_raw:     modeA ? selectedStrong : null,
          strong_val:     modeA ? STRONG_MAP[selectedStrong] : null,
          taste_raw:      modeA ? selectedTaste  : null,
          taste_val:      modeA ? TASTE_MAP[selectedTaste]  : null,
          exclude_idx: Array.from(excludedCats),
          cat_labels: Array.from(selectedCats).map(i => CATEGORY_OPTIONS[i]),
          exclude_labels: Array.from(excludedCats).map(i => CATEGORY_OPTIONS[i]),
        };

        try {
          _tg.sendData(JSON.stringify(payload));
          setTimeout(()=>{ try{ _tg.close(); }catch(_){} }, 100);
        } catch (e){
          console.error('sendData error', e);
          showErr('Ошибка отправки в Telegram: ' + (e?.message || e));
        }
      });
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Бренды-исключения — TryToMix</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      /* Палитра как у фильтра-генерации */
      --bg: #FFF7F2;
      --card:#FFFFFF;
      --text:#1E1E1E;
      --muted:#6B6B6B;
      --accent:#006D77;
      --radius:16px;
      --pad:16px;
      --shadow:0 8px 24px rgba(0,0,0,.08);
      --border:#E8E8E8;
    }
    html,body{margin:0; padding:0; background:var(--bg); color:var(--text); font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;}
    .wrap{max-width:860px; margin:0 auto; padding:24px;}
    header{display:flex; align-items:center; gap:12px; margin-bottom:20px;}
    header img{width:36px; height:36px; object-fit:contain; border-radius:8px;}
    h1{font-size:20px; margin:0;}

    .card{background:var(--card); border-radius:var(--radius); padding:var(--pad); box-shadow:var(--shadow);}
    .sticky{position:sticky; top:0; z-index:10; background:linear-gradient(180deg, rgba(255,247,242,0.8) 0%, rgba(255,247,242,1) 60%); border-radius:var(--radius); padding:8px 12px; margin-bottom:16px;}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    .search{flex:1 1 320px;}
    input[type="text"]{width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:#fff; color:var(--text); box-shadow:inset 0 1px 0 rgba(0,0,0,.03);}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap;}
    button{cursor:pointer; border:1px solid var(--border); background:#fff; color:var(--text); padding:10px 14px; border-radius:12px; font-weight:700; box-shadow:0 1px 0 rgba(0,0,0,.02);}
    button:hover{background:#FAFAFA;}
    .pill{font-size:12px; color:var(--muted); align-self:center;}
    .hint{color:var(--muted); font-size:13px; margin-top:8px;}

    .list{margin-top:16px; display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:12px;}
    .item{display:grid; grid-template-columns:28px 1fr; gap:10px; align-items:center; padding:12px 14px; border-radius:14px; background:var(--card); border:1px solid var(--border); box-shadow:var(--shadow);}
    .item:hover{background:#FEFEFE;}
    .empty{color:var(--muted); text-align:center; padding:24px; grid-column:1 / -1;}

    /* Чекбокс покрупнее */
    .item input[type="checkbox"]{
      width:20px; height:20px; accent-color:var(--accent); cursor:pointer;
    }
    .item label{cursor:pointer; font-weight:600;}

    /* Низ страницы — пояснение про MainButton */
    .footnote{margin-top:16px; text-align:center; color:var(--muted); font-size:13px;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="./Logo_TryToMix.png" alt="TryToMix">
      <h1>Бренды-исключения</h1>
    </header>

    <div class="card sticky">
      <div class="row">
        <div class="search"><input id="q" type="text" placeholder="Поиск по брендам…" /></div>
        <div class="toolbar">
          <button id="selectAll">Выбрать всё (видимое)</button>
          <button id="clearAll">Снять всё</button>
          <span id="counter" class="pill">Выбрано: 0</span>
        </div>
      </div>
      <div class="hint">
        Снятые галочки будут сохранены как <b>исключения</b>. Для отправки нажмите большую кнопку внизу Telegram (Main Button).
      </div>
    </div>

    <div id="list" class="list"></div>

    <div class="footnote">Дизайн унифицирован с «Фильтр-генерации» для единого UX.</div>
  </div>

  <script>
    // ====== Telegram API & тема (оставляем логику, только применяем к нашей палитре) ======
    const tg = window.Telegram?.WebApp; try{ tg?.ready(); tg?.expand(); }catch(_){}
    const applyTheme = () => {
      if (!tg) return; const p = tg.themeParams || {};
      // Аккуратно маппим тёмные темы на нашу светлую палитру (если хочется — можно закомментить эти 4 строки)
      if (p.bg_color)        document.documentElement.style.setProperty('--bg', '#FFF7F2');
      if (p.secondary_bg_color) document.documentElement.style.setProperty('--card', '#FFFFFF');
      if (p.text_color)      document.documentElement.style.setProperty('--text', '#1E1E1E');
      if (p.hint_color)      document.documentElement.style.setProperty('--muted', '#6B6B6B');
      if (p.button_color)    document.documentElement.style.setProperty('--accent', '#006D77');
    };
    applyTheme(); tg?.onEvent('themeChanged', applyTheme);

    // ====== Параметры URL ======
    function getParam(name){ return new URLSearchParams(window.location.search).get(name); }
    function parseCSV(str){ if(!str) return []; return str.split(',').map(s=>s.trim()).filter(Boolean); }
    function parseB64JsonArray(b64){
      if(!b64) return [];
      try{
        const fixed = b64.replace(/-/g,'+').replace(/_/g,'/');
        const pad = '='.repeat((4 - (fixed.length % 4)) % 4);
        const bin = atob(fixed + pad);
        const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
        const json = new TextDecoder("utf-8").decode(bytes);
        const arr = JSON.parse(json);
        return Array.isArray(arr) ? arr : [];
      }catch(e){ console.error("parseB64JsonArray error:", e); return []; }
    }

    // ====== ДАННЫЕ: бренды из URL или дефолт (ЛОГИКУ НЕ ТРОГАЕМ) ======
    const creatorsFromB64 = parseB64JsonArray(getParam('creators_b64'));
    const creatorsFromCSV = parseCSV(getParam('creators'));
    const SOURCE_CREATORS = (creatorsFromB64.length ? creatorsFromB64 : creatorsFromCSV);
    const DEFAULT_CREATORS = ['SEBERO','DARKSIDE','ELEMENT','DUFT','Satyr','Sarma 360'];
    const CREATORS = (SOURCE_CREATORS.length ? SOURCE_CREATORS : DEFAULT_CREATORS).map(x=>String(x));
    const OPTIONS = CREATORS.map((name, idx) => ({ id: idx+1, name }));

    // ====== Состояние ======
    const state = { query: '', selected: new Set() };
    const listEl = document.getElementById('list');
    const qEl = document.getElementById('q');
    const counterEl = document.getElementById('counter');

    function initSelectionWithExclusions(){
      // по умолчанию — всё выбрано
      OPTIONS.forEach(o => state.selected.add(o.id));
      // исключения из URL (именами брендов)
      const exclNames = parseB64JsonArray(getParam('excl_b64'));
      const exclFallback = exclNames.length ? [] : parseCSV(getParam('excl'));
      const exclSet = new Set((exclNames.length ? exclNames : exclFallback).map(x=>String(x)));
      if(exclSet.size){ OPTIONS.forEach(o=>{ if(exclSet.has(o.name)) state.selected.delete(o.id); }); }
    }

    function render(){
      const q = state.query.trim().toLowerCase();
      const filtered = q ? OPTIONS.filter(o => o.name.toLowerCase().includes(q)) : OPTIONS;
      listEl.innerHTML = '';
      if(!filtered.length){ listEl.innerHTML = '<div class="empty card">Ничего не найдено</div>'; }
      else{
        const frag = document.createDocumentFragment();
        filtered.forEach(o => {
          const row = document.createElement('div'); row.className = 'item';
          const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = state.selected.has(o.id);
          cb.addEventListener('change', ()=>{ if(cb.checked) state.selected.add(o.id); else state.selected.delete(o.id); updateMainButton(); });
          const label = document.createElement('label'); label.textContent = o.name;
          label.addEventListener('click', ()=>{ cb.checked = !cb.checked; cb.dispatchEvent(new Event('change')); });
          row.appendChild(cb); row.appendChild(label);
          frag.appendChild(row);
        });
        listEl.appendChild(frag);
      }
      updateCounter();
    }

    function updateCounter(){ counterEl.textContent = `Выбрано: ${state.selected.size}`; }
    function updateMainButton(){ updateCounter(); if(!tg) return; const n = state.selected.size; tg.MainButton.setText(n?`Отправить (${n})`:'Отправить'); if(n) tg.MainButton.show(); else tg.MainButton.hide(); }

    qEl.addEventListener('input', ()=>{ state.query = qEl.value; render(); });
    document.getElementById('selectAll').addEventListener('click', ()=>{
      const q = state.query.trim().toLowerCase();
      const filtered = q? OPTIONS.filter(o=>o.name.toLowerCase().includes(q)) : OPTIONS;
      filtered.forEach(o=>state.selected.add(o.id));
      render();
    });
    document.getElementById('clearAll').addEventListener('click', ()=>{ state.selected.clear(); render(); });

    if(tg){
      tg.MainButton.setText('Отправить'); tg.MainButton.hide();
      tg.onEvent('mainButtonClicked', ()=>{
        // отправляем ТОЛЬКО исключённые (ЛОГИКА НЕ МЕНЯЛАСЬ)
        const excluded = OPTIONS.filter(o => !state.selected.has(o.id)).map(o => ({ name: o.name }));
        const payload = { type: 'exclude_selection', excluded };
        try { tg.sendData(JSON.stringify(payload)); } catch(e) { console.error('sendData error', e); }
        setTimeout(()=>{ try{ tg.close(); }catch(_){} }, 100);
      });
    }

    initSelectionWithExclusions();
    render();
  </script>
</body>
</html>
